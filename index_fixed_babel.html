<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>歌える曲リスト v5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM (production) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel to transpile JSX in-browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-black text-white">
    <noscript>このサイトを表示するにはJavaScriptを有効にしてください。</noscript>
    <div id="root" class="min-h-screen flex items-center justify-center">
      <div class="text-center opacity-60">読み込み中…</div>
    </div>

    <!-- IMPORTANT: data-presets so JSX is transpiled -->
    <script type="text/babel" data-presets="env,react">
      const { useEffect, useMemo, useState } = React;

      const LS_KEY = "songs_v5";
      const TODAY = () => {
        const d = new Date();
        const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
        return tz.toISOString().slice(0,10);
      };

      function useLocalStorage(key, initial) {
        const [value, setValue] = useState(() => {
          try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial; } catch { return initial; }
        });
        useEffect(() => { try { localStorage.setItem(key, JSON.stringify(value)); } catch {} }, [key, value]);
        return [value, setValue];
      }

      function App() {
        const [songs, setSongs] = useLocalStorage(LS_KEY, []);
        const [query, setQuery] = useState("");
        const [sortKey, setSortKey] = useState("title"); // title | createdAt | lastPerformed
        const [sortAsc, setSortAsc] = useState(true);
        const [onlyUnperformed, setOnlyUnperformed] = useState(false);
        const [bulkText, setBulkText] = useState("");
        const [randomSong, setRandomSong] = useState(null);
        const [confirmDelId, setConfirmDelId] = useState(null);
        const [confirmAllOpen, setConfirmAllOpen] = useState(false);

        useEffect(()=>{
          if (!songs.length) setSongs([{ id: Date.now(), title: "サンプル", createdAt: TODAY(), lastPerformed: "" }]);
        },[]);

        const filtered = useMemo(()=>{
          let list = [...songs];
          if (query.trim()) list = list.filter(s=>s.title.toLowerCase().includes(query.toLowerCase()));
          if (onlyUnperformed) list = list.filter(s=>!s.lastPerformed);
          list.sort((a,b)=>{
            if (sortKey === "createdAt" || sortKey === "lastPerformed") {
              const A = a[sortKey]? new Date(a[sortKey]).getTime(): -Infinity;
              const B = b[sortKey]? new Date(b[sortKey]).getTime(): -Infinity;
              return sortAsc ? A-B : B-A;
            }
            const A = (a.title||"").toLowerCase();
            const B = (b.title||"").toLowerCase();
            if (A < B) return sortAsc ? -1 : 1;
            if (A > B) return sortAsc ? 1 : -1;
            return 0;
          });
          return list;
        },[songs, query, sortKey, sortAsc, onlyUnperformed]);

        const arrow = (k) => (sortKey === k ? (sortAsc ? "▲" : "▼") : "");

        const recordToday = (id) => setSongs(prev=>prev.map(s=>s.id===id?{...s,lastPerformed:TODAY()}:s));
        const copyTitle = (t) => { navigator.clipboard.writeText(t); alert(`コピー: ${t}`); };

        const addFromText = () => {
          if (!bulkText.trim()) return;
          const lines = bulkText.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
          const existing = new Set(songs.map(s=>s.title.toLowerCase()));
          const out=[]; const dups=[];
          lines.forEach((line,i)=>{
            const title=line.replace(/\s*[-–（(,、\t].*$/,'').trim();
            if (!title) return;
            if (existing.has(title.toLowerCase())) {dups.push(title); return;}
            out.push({id:Date.now()+i,title,createdAt: TODAY(), lastPerformed:""});
            existing.add(title.toLowerCase());
          });
          if (dups.length) alert(`重複スキップ:\n${dups.join("\n")}`);
          if (out.length) setSongs(prev=>[...prev,...out]);
          setBulkText("");
        };

        const deleteSong = (id) => setConfirmDelId(id);
        const deleteAll = () => setConfirmAllOpen(true);

        const draw=()=>{
          if(!songs.length) return alert("曲がありません");
          const next=songs[Math.floor(Math.random()*songs.length)];
          setRandomSong(next); // 自動記録しない
        };

        return (
          <div className="min-h-screen bg-black text-white px-4 py-6 sm:px-6 lg:px-8 text-[17px] leading-7">
            <div className="max-w-6xl mx-auto">
              <header className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
                <div>
                  <h1 className="text-3xl font-bold tracking-tight">歌える曲リスト v5.2</h1>
                  <p className="text-sm opacity-80 mt-1">table固定・ヘッダソート・抽選結果表示</p>
                </div>
                <div className="flex gap-2 flex-wrap">
                  <input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="曲名検索" className="rounded-2xl border border-white/30 bg-black text-white placeholder-white/50 px-3 py-2" />
                  <button onClick={()=>setOnlyUnperformed(v=>!v)} className="rounded-2xl px-3 py-2 border border-white/30 shadow-sm hover:bg-white/10">{onlyUnperformed?"未唱のみ:ON":"未唱のみ:OFF"}</button>
                  <button onClick={draw} className="rounded-2xl px-3 py-2 border border-white/30 shadow-sm hover:bg-white/10">ランダム抽選</button>
                  <button onClick={deleteAll} className="rounded-2xl px-3 py-2 border border-white/30 shadow-sm hover:bg-white/10">全削除</button>
                </div>
              </header>

              {randomSong && (
                <div className="mt-6 p-4 border border-white/20 rounded-2xl bg-white/10 shadow-sm">
                  <div className="text-sm opacity-80">🎲 抽選結果</div>
                  <div className="text-3xl md:text-4xl font-bold mt-1 break-words">{randomSong.title}</div>
                  <div className="mt-3 flex gap-2">
                    <button onClick={()=>recordToday(randomSong.id)} className="rounded-2xl px-3 py-2 border border-white/30 shadow-sm hover:bg-white/10">今日</button>
                    <button onClick={()=>copyTitle(randomSong.title)} className="rounded-2xl px-3 py-2 border border-white/30 shadow-sm hover:bg-white/10">コピー</button>
                  </div>
                </div>
              )}

              <textarea value={bulkText} onChange={(e)=>setBulkText(e.target.value)} placeholder="曲名を改行で追加" className="w-full h-24 bg-black text-white border border-white/30 rounded-2xl px-3 py-2 mt-4"/>
              <button onClick={addFromText} className="mt-2 rounded-2xl px-3 py-2 border border-white/30 shadow-sm hover:bg-white/10">追加</button>

              <div className="overflow-hidden rounded-2xl border border-white/20 shadow-sm mt-6">
                <table className="w-full text-[16px]">
                  <thead className="bg-white/10">
                    <tr>
                      <th className="p-3 w-14 text-left">#</th>
                      <th className="p-3 text-left">
                        <button onClick={() => { setSortAsc(sortKey==='title' ? !sortAsc : true); setSortKey('title'); }} className="underline underline-offset-2 hover:opacity-80">
                          曲名 {arrow('title')}
                        </button>
                      </th>
                      <th className="p-3 text-left w-40">
                        <button onClick={() => { setSortAsc(sortKey==='createdAt' ? !sortAsc : true); setSortKey('createdAt'); }} className="underline underline-offset-2 hover:opacity-80">
                          追加日 {arrow('createdAt')}
                        </button>
                      </th>
                      <th className="p-3 text-left w-40">
                        <button onClick={() => { setSortAsc(sortKey==='lastPerformed' ? !sortAsc : true); setSortKey('lastPerformed'); }} className="underline underline-offset-2 hover:opacity-80">
                          歌った日 {arrow('lastPerformed')}
                        </button>
                      </th>
                      <th className="p-3 text-left w-40">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.map((s,i)=>(
                      <tr key={s.id} className="border-t border-white/10 hover:bg-white/5">
                        <td className="p-3 align-top">{i+1}</td>
                        <td className="p-3 align-top font-medium">
                          <button onClick={()=>recordToday(s.id)} className="underline underline-offset-2 decoration-dotted hover:opacity-80">{s.title}</button>
                        </td>
                        <td className="p-3 align-top">{s.createdAt||"—"}</td>
                        <td className="p-3 align-top">{s.lastPerformed||"—"}</td>
                        <td className="p-3 align-top flex gap-2">
                          <button onClick={()=>recordToday(s.id)} className="rounded-xl border border-white/30 px-2 py-1 hover:bg-white/10">今日</button>
                          <button onClick={()=>copyTitle(s.title)} className="rounded-xl border border-white/30 px-2 py-1 hover:bg-white/10">コピー</button>
                          <button onClick={()=>setConfirmDelId(s.id)} className="rounded-xl border border-white/30 px-2 py-1 hover:bg-white/10">🗑️</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {confirmDelId!==null&&(
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
                  <div className="w-[90%] max-w-sm rounded-2xl border border-white/20 bg-black p-4 text-white shadow-xl">
                    <div className="text-lg font-semibold">この曲を削除しますか？</div>
                    <div className="mt-3 flex gap-2 justify-end">
                      <button onClick={()=>setConfirmDelId(null)} className="rounded-xl border border-white/30 px-3 py-2 hover:bg-white/10">キャンセル</button>
                      <button onClick={()=>{setSongs(prev=>prev.filter(s=>s.id!==confirmDelId)); if(randomSong?.id===confirmDelId) setRandomSong(null); setConfirmDelId(null);}} className="rounded-xl border border-white/30 px-3 py-2 hover:bg-white/10">削除する</button>
                    </div>
                  </div>
                </div>
              )}
              {confirmAllOpen&&(
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
                  <div className="w-[90%] max-w-sm rounded-2xl border border-white/20 bg-black p-4 text-white shadow-xl">
                    <div className="text-lg font-semibold">リストをすべて削除します。よろしいですか？</div>
                    <div className="mt-3 flex gap-2 justify-end">
                      <button onClick={()=>setConfirmAllOpen(false)} className="rounded-xl border border-white/30 px-3 py-2 hover:bg-white/10">キャンセル</button>
                      <button onClick={()=>{setSongs([]); setRandomSong(null); setConfirmAllOpen(false);}} className="rounded-xl border border-white/30 px-3 py-2 hover:bg-white/10">全削除する</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
